#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include "chacha20-c/chacha20.h"

uint8_t nonce[12] = { 0 };
uint8_t encrypted_flag[30] = "\xF4\xB8\xC0\x90\xCD\xF6\xCB\xF7\xC5\x42"
							 "\x30\xF3\x75\x04\x2C\x4B\xFD\x9D\x96\x02"
							 "\x57\x79\x9A\x7A\xEE\x75\xD9\xF0\x4C";
unsigned int next = 0;

void custom_srand(uint __seed)
{
	next = (ulong)__seed;	
	return;
}   

int custom_rand(void)
{   
	next = next * 0x41c64e6d + 0x3039;
	return (uint)((ulong)next >> 0x10) & 0x7fff;
}

int main()
{
	int seed = 0;
	int current_fruit_x = 0;
	int current_fruit_y = 0;
	int password_idx = 0;
	uint8_t password[0x20], dec_flag[30];
	struct chacha20_context context;

	for(int seed = 0; seed < 20000; seed++)
	{
		password_idx = 0;
		memset(&password, 0, sizeof(password));
		memset(&dec_flag, 0, sizeof(dec_flag));
		memset(&context, 0, sizeof(struct chacha20_context));

		memcpy(dec_flag, encrypted_flag, 30);

		custom_srand(seed);

		for(int i = 0; i < 547; i++)
		{
			current_fruit_y = custom_rand() % 0x12 + 1;
			current_fruit_x = custom_rand() % 0x26 + 1;
			password[password_idx] = (char)current_fruit_x + password[password_idx];
			password[password_idx] = password[password_idx] * (char)current_fruit_y;
			password_idx = (password_idx + 1) % 0x20;
		}
		
		chacha20_init_context(&context, password, nonce, 0);
		chacha20_xor(&context, dec_flag, 0x1d);
		if (!strncmp("brb{", (char*) dec_flag, 4))
		{
			printf("[!] Flag found at seed: %.4x\n", (unsigned int) seed);
			printf("[!] Flag: %s\n", (char*) dec_flag);
		}
	}
	return 0;
}
